# This file is a template, and might need editing before it works on your project.
# This is a sample GitLab CI/CD configuration file that should run without any modifications.
# It demonstrates a basic 3 stage CI/CD pipeline. Instead of real tests or scripts,
# it uses echo commands to simulate the pipeline execution.
#
# A pipeline is composed of independent jobs that run scripts, grouped into stages.
# Stages run in sequential order, but jobs within stages run in parallel.
#
# For more information, see: https://docs.gitlab.com/ee/ci/yaml/#stages
#
# You can copy and paste this template into a new `.gitlab-ci.yml` file.
# You should not add this template to an existing `.gitlab-ci.yml` file by using the `include:` keyword.
#
# To contribute improvements to CI/CD templates, please follow the Development guide at:
# https://docs.gitlab.com/development/cicd/templates/
# This specific template is located at:
# https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Getting-Started.gitlab-ci.yml

# ================================
# Définition des stages de la pipeline
# L'ordre définit l'ordre d'exécution
# ================================
stages:
  - build     # Étape de construction (ex: préparation du projet)
  - test      # Étape de tests (jobs exécutés en parallèle)
  - deploy    # Étape de déploiement (ici simulée)
  - cleanup   # Étape de nettoyage final

# ================================
# Variables d'environnement globales
# Disponibles dans tous les jobs
# ================================
variables:
  PROJECT_NAME: "projet_jeu"              # Nom du projet
  DEPLOY_SITE: "https://example.com/"     # URL de déploiement (exemple)

# ================================
# Image Docker par défaut
# Utilisée pour tous les jobs
# ================================
default:
  image: alpine:3.20                      # Image Linux légère

# ================================
# JOB : BUILD
# Préparation et vérifications simples
# ================================
build-job:
  stage: build                            # Le job appartient au stage "build"
  script:
    - echo "Hello, $GITLAB_USER_LOGIN!"   # Variable GitLab : utilisateur déclencheur
    - echo "Project: $PROJECT_NAME"       # Variable personnalisée
    - echo "Branch: $CI_COMMIT_BRANCH"    # Branche courante
    - echo "Commit: $CI_COMMIT_SHORT_SHA" # Identifiant court du commit
    - echo "Listing files:"               # Affiche le contenu du dépôt
    - ls -la

  # Artefacts sauvegardés après l'exécution du job
  artifacts:
    expire_in: 1 week                     # Durée de conservation
    paths:
      - README.md                         # Exemple de fichier conservé
      - index.html

# ================================
# JOB : TEST 1
# Test rapide (simulation)
# ================================
test-job1:
  stage: test                             # Appartient au stage "test"
  script:
    - echo "This job tests something"     # Simulation d'un test
    - echo "Quick check done."

# ================================
# JOB : TEST 2
# Test plus long (simulation)
# Exécuté en parallèle avec test-job1
# ================================
test-job2:
  stage: test
  script:
    - echo "This job tests something, but takes more time than test-job1."
    - echo "Simulating a longer test..."
    - sleep 20                            # Simulation d'un test long
    - echo "Long test done."

# ================================
# JOB : DEPLOY
# Déploiement simulé, déclenché manuellement
# ================================
deploy-prod:
  stage: deploy
  script:
    - echo "This job deploys something from the $CI_COMMIT_BRANCH branch."
    - echo "Deploy site: $DEPLOY_SITE"
    - echo "Deploy placeholder (no real deploy)"

  environment: production                 # Environnement GitLab "production"
  when: manual                            # Lancement manuel du job

  # Règles : visible uniquement sur la branche main
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
    - when: never

# ================================
# JOB : CLEANUP
# Nettoyage exécuté quoi qu'il arrive
# ================================
cleanup-job:
  stage: cleanup
  script:
    - echo "Cleanup always runs (even if previous jobs failed)."

  when: always                            # Exécution même en cas d'échec

